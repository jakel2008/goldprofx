{% extends "base.html" %}

{% block content %}
<div class="signals-section">
  <h2>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
  <p style="color:#666;margin:0.5rem 0 1rem">Ù…Ø±Ø­Ø¨Ø§ {{ user.username }} â€” Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ø¯Ù…Ù†</p>

  <!-- Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
  <div style="margin:1rem 0;border-bottom:2px solid #eee">
    <button class="tab-btn active" onclick="showTab('users')">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</button>
    <button class="tab-btn" onclick="showTab('subscriptions')">ğŸ’ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button>
    <button class="tab-btn" onclick="showTab('requests')">ğŸ“¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† -->
  <div id="users-tab" class="tab-content active">
    <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <div id="users-table-container" style="overflow:auto">
      <table id="users-table" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#f0f2ff">
            <th style="padding:8px;border-bottom:1px solid #eee">#</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø§Ø³Ù…</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø®Ø·Ø©</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ù†Ø´Ø·</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø£Ø¯Ù…Ù†</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="users-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª -->
  <div id="subscriptions-tab" class="tab-content" style="display:none">
    <h3>ğŸ’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h3>
    <div id="subscriptions-table-container" style="overflow:auto">
      <table id="subscriptions-table" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#f0f2ff">
            <th style="padding:8px;border-bottom:1px solid #eee">ID</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø®Ø·Ø©</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="subscriptions-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ -->
  <div id="requests-tab" class="tab-content" style="display:none">
    <h3>ğŸ“¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
    <div style="background:#fff3cd;padding:1rem;border-radius:8px;margin-bottom:1rem;border-left:4px solid #ffc107">
      <strong>ğŸ“§ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¯Ø¹Ù…:</strong> mahmoodalqaise750@gmail.com<br>
      <small>Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯</small>
    </div>
    <div id="requests-table-container" style="overflow:auto">
      <table id="requests-table" style="width:100%;border-collapse:collapse;font-size:0.9rem">
        <thead>
          <tr style="background:#f0f2ff">
            <th style="padding:8px;border-bottom:1px solid #eee">#</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø®Ø·Ø©</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø³Ø¹Ø±</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ù…Ø¯Ø©</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th style="padding:8px;border-bottom:1px solid #eee">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="requests-body"></tbody>
      </table>
    </div>
  </div>
</div>

<style>
.tab-btn {
  background:transparent;
  border:none;
  padding:0.5rem 1rem;
  cursor:pointer;
  font-size:1rem;
  color:#666;
  border-bottom:2px solid transparent;
  transition:all 0.3s;
}
.tab-btn.active {
  color:#6366f1;
  border-bottom-color:#6366f1;
}
.tab-content {
  margin-top:1rem;
}
.action-btn {
  padding:4px 8px;
  margin:2px;
  font-size:0.85rem;
  border:none;
  border-radius:4px;
  cursor:pointer;
  transition:all 0.2s;
}
.btn-success { background:#10b981; color:white; }
.btn-success:hover { background:#059669; }
.btn-danger { background:#ef4444; color:white; }
.btn-danger:hover { background:#dc2626; }
.btn-warning { background:#f59e0b; color:white; }
.btn-warning:hover { background:#d97706; }
.btn-info { background:#3b82f6; color:white; }
.btn-info:hover { background:#2563eb; }
</style>

<script>
function showTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  
  if (tab === 'users') {
    document.getElementById('users-tab').style.display = 'block';
    event.target.classList.add('active');
    loadUsers();
  } else if (tab === 'subscriptions') {
    document.getElementById('subscriptions-tab').style.display = 'block';
    event.target.classList.add('active');
    loadSubscriptions();
  } else if (tab === 'requests') {
    document.getElementById('requests-tab').style.display = 'block';
    event.target.classList.add('active');
    loadRequests();
  }
}

async function loadUsers() {
  const res = await fetch('/api/admin/users');
  const data = await res.json();
  const body = document.getElementById('users-body');
  body.innerHTML = '';
  if (!data.success) { 
    body.innerHTML = '<tr><td colspan="9">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>'; 
    return; 
  }
  data.users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid #eee">${u.id}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${u.username}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${u.email}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${u.full_name || '-'}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <select onchange="changeUserPlan(${u.id}, this.value)" style="padding:4px">
          <option value="free" ${u.plan === 'free' ? 'selected' : ''}>Free</option>
          <option value="bronze" ${u.plan === 'bronze' ? 'selected' : ''}>Bronze</option>
          <option value="silver" ${u.plan === 'silver' ? 'selected' : ''}>Silver</option>
          <option value="gold" ${u.plan === 'gold' ? 'selected' : ''}>Gold</option>
          <option value="platinum" ${u.plan === 'platinum' ? 'selected' : ''}>Platinum</option>
        </select>
      </td>
      <td style="padding:8px;border-bottom:1px solid #eee">${u.is_active ? 'âœ…' : 'âŒ'}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${u.is_admin ? 'â­' : '-'}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${u.last_login || '-'}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <button class="action-btn ${u.is_active ? 'btn-danger' : 'btn-success'}" 
                onclick="toggleActive(${u.id}, ${u.is_active ? 0 : 1})">
          ${u.is_active ? 'Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙØ¹ÙŠÙ„'}
        </button>
        <button class="action-btn ${u.is_admin ? 'btn-warning' : 'btn-info'}" 
                onclick="toggleAdmin(${u.id}, ${u.is_admin ? 0 : 1})">
          ${u.is_admin ? 'Ø¥Ø²Ø§Ù„Ø© Ø£Ø¯Ù…Ù†' : 'ØªØ±Ù‚ÙŠØ©'}
        </button>
      </td>
    `;
    body.appendChild(tr);
  });
}

async function loadSubscriptions() {
  const res = await fetch('/api/admin/subscriptions');
  const data = await res.json();
  const body = document.getElementById('subscriptions-body');
  body.innerHTML = '';
  if (!data.success) { 
    body.innerHTML = '<tr><td colspan="9">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</td></tr>'; 
    return; 
  }
  data.subscriptions.forEach(s => {
    const tr = document.createElement('tr');
    const startDate = s.subscription_start ? new Date(s.subscription_start).toLocaleDateString('ar') : '-';
    const endDate = s.subscription_end ? new Date(s.subscription_end).toLocaleDateString('ar') : '-';
    
    tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid #eee">${s.user_id}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${s.username || '-'}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${s.first_name || '-'}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${s.plan}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${startDate}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${endDate}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <span style="padding:4px 8px;border-radius:4px;background:${getStatusColor(s.status)};color:white">
          ${getStatusText(s.status)}
        </span>
      </td>
      <td style="padding:8px;border-bottom:1px solid #eee">$${s.total_paid || 0}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <button class="action-btn btn-info" onclick="extendSub(${s.user_id})">ØªÙ…Ø¯ÙŠØ¯</button>
        ${s.status === 'active' ? 
          `<button class="action-btn btn-danger" onclick="cancelSub(${s.user_id})">Ø¥Ù„ØºØ§Ø¡</button>` :
          `<button class="action-btn btn-success" onclick="reactivateSub(${s.user_id})">Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„</button>`
        }
      </td>
    `;
    body.appendChild(tr);
  });
}

function getStatusColor(status) {
  const colors = {
    'active': '#10b981',
    'trial': '#3b82f6',
    'cancelled': '#ef4444',
    'expired': '#f59e0b'
  };
  return colors[status] || '#6b7280';
}

function getStatusText(status) {
  const texts = {
    'active': 'Ù†Ø´Ø·',
    'trial': 'ØªØ¬Ø±ÙŠØ¨ÙŠ',
    'cancelled': 'Ù…Ù„ØºÙŠ',
    'expired': 'Ù…Ù†ØªÙ‡ÙŠ'
  };
  return texts[status] || status;
}

async function toggleAdmin(user_id, is_admin) {
  const res = await fetch('/api/admin/set_admin', {
    method: 'POST', 
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ user_id, is_admin })
  });
  const data = await res.json();
  if (data.success) { 
    loadUsers(); 
    alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­');
  } else { 
    alert('ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†'); 
  }
}

async function toggleActive(user_id, is_active) {
  const res = await fetch('/api/admin/set_active', {
    method: 'POST', 
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ user_id, is_active })
  });
  const data = await res.json();
  if (data.success) { 
    loadUsers(); 
    alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
  } else { 
    alert('ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„'); 
  }
}

async function changeUserPlan(user_id, plan) {
  const res = await fetch('/api/admin/update_plan', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ user_id, plan })
  });
  const data = await res.json();
  if (data.success) {
    alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·Ø© Ø¥Ù„Ù‰ ${plan} Ø¨Ù†Ø¬Ø§Ø­`);
    loadUsers();
    loadSubscriptions();
  } else {
    alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·Ø©: ' + data.message);
  }
}

async function extendSub(user_id) {
  const days = prompt('ÙƒÙ… ÙŠÙˆÙ… ØªØ±ÙŠØ¯ Ø§Ù„ØªÙ…Ø¯ÙŠØ¯ØŸ', '30');
  if (!days) return;
  
  const res = await fetch('/api/admin/extend_subscription', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ user_id, days: parseInt(days) })
  });
  const data = await res.json();
  alert(data.message);
  if (data.success) loadSubscriptions();
}

async function cancelSub(user_id) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ')) return;
  
  const res = await fetch('/api/admin/cancel_subscription', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ user_id })
  });
  const data = await res.json();
  alert(data.message);
  if (data.success) loadSubscriptions();
}

async function reactivateSub(user_id) {
  const res = await fetch('/api/admin/reactivate_subscription', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ user_id })
  });
  const data = await res.json();
  alert(data.message);
  if (data.success) loadSubscriptions();
}

async function loadRequests() {
  const res = await fetch('/api/admin/subscription_requests');
  const data = await res.json();
  const body = document.getElementById('requests-body');
  body.innerHTML = '';
  
  if (!data.success) { 
    body.innerHTML = '<tr><td colspan="11">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</td></tr>'; 
    return; 
  }
  
  if (data.requests.length === 0) {
    body.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:2rem;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
    return;
  }
  
  data.requests.forEach(r => {
    const tr = document.createElement('tr');
    const requestDate = new Date(r.request_date).toLocaleString('ar');
    const statusBg = r.status === 'pending' ? '#ffc107' : 
                     r.status === 'approved' ? '#10b981' : '#ef4444';
    const statusText = r.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : 
                       r.status === 'approved' ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø±ÙÙˆØ¶';
    
    // ØªØ­Ø¯ÙŠØ¯ Ù†Øµ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
    const paymentMethods = {
      'cliq': 'ğŸ“± CliQ',
      'bank_transfer': 'ğŸ¦ Ø­ÙˆØ§Ù„Ø© Ø¨Ù†ÙƒÙŠØ©',
      'visa': 'ğŸ’³ ÙÙŠØ²Ø§/Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯',
      'crypto': 'â‚¿ Ø¹Ù…Ù„Ø§Øª Ø±Ù‚Ù…ÙŠØ©'
    };
    const paymentMethodText = paymentMethods[r.payment_method] || r.payment_method || '-';
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    const locationText = r.location === 'jordan' ? 'ğŸ‡¯ğŸ‡´ Ø§Ù„Ø£Ø±Ø¯Ù†' : 
                        r.location === 'international' ? 'ğŸŒ Ø¯ÙˆÙ„ÙŠ' : '-';
    
    tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid #eee">${r.id}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <strong>${r.username}</strong><br>
        <small>${r.full_name || '-'}</small>
      </td>
      <td style="padding:8px;border-bottom:1px solid #eee"><small>${r.email}</small></td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <span style="padding:4px 8px;background:#6366f1;color:white;border-radius:4px;font-size:0.85rem">
          ${r.plan.toUpperCase()}
        </span>
      </td>
      <td style="padding:8px;border-bottom:1px solid #eee">$${r.price}</td>
      <td style="padding:8px;border-bottom:1px solid #eee">${r.duration_days}Ø¯</td>
      <td style="padding:8px;border-bottom:1px solid #eee"><small>${locationText}</small></td>
      <td style="padding:8px;border-bottom:1px solid #eee"><small>${paymentMethodText}</small></td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <small>${r.transaction_id || '-'}</small>
      </td>
      <td style="padding:8px;border-bottom:1px solid #eee"><small>${requestDate}</small></td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        <span style="padding:4px 8px;border-radius:4px;background:${statusBg};color:white;font-size:0.85rem">
          ${statusText}
        </span>
      </td>
      <td style="padding:8px;border-bottom:1px solid #eee">
        ${r.status === 'pending' ? `
          <button class="action-btn btn-success" onclick="approveRequest(${r.id})">âœ… ØªÙØ¹ÙŠÙ„</button>
          <button class="action-btn btn-danger" onclick="rejectRequest(${r.id})">âŒ Ø±ÙØ¶</button>
        ` : `
          <small style="color:#666">${r.status === 'approved' ? 'ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„' : 'ØªÙ… Ø§Ù„Ø±ÙØ¶'}</small>
        `}
      </td>
    `;
    body.appendChild(tr);
  });
}

async function approveRequest(requestId) {
  const notes = prompt('Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', '');
  if (notes === null) return;
  
  const res = await fetch('/api/admin/approve_subscription', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ request_id: requestId, admin_notes: notes })
  });
  const data = await res.json();
  alert(data.message);
  if (data.success) {
    loadRequests();
    loadUsers();
    loadSubscriptions();
  }
}

async function rejectRequest(requestId) {
  const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:', '');
  if (!reason) return;
  
  const res = await fetch('/api/admin/reject_subscription', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ request_id: requestId, admin_notes: reason })
  });
  const data = await res.json();
  alert(data.message);
  if (data.success) loadRequests();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadUsers();
</script>
{% endblock %}
