"""
ููู ุงูุชูุงูู ุจูู ูุธุงู ุงูุชุญููู ุงูุชููุงุฆู ูุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู
ูููุฑ ุงูุฏูุงู ุงููุทููุจุฉ ููุชูุงูู ุงูุณูุณ
"""

import os
import sys
from datetime import datetime, date
from pathlib import Path

def get_bot_credentials():
    """ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุจูุช ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุฃู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ"""
    token = os.environ.get("MM_TELEGRAM_BOT_TOKEN", "8253445917:AAEajrjXavN5Ebz8pSKeU8frqIyI84zi26A")
    chat_id = os.environ.get("MM_TELEGRAM_CHAT_ID", "7657829546")
    return token, chat_id


def setup_auto_analyzer():
    """ุฅุนุฏุงุฏ ูุธุงู ุงูุชุญููู ุงูุชููุงุฆู"""
    print("๐ ุฅุนุฏุงุฏ ูุธุงู ุงูุชุญููู ุงูุชููุงุฆู...")
    
    required_packages = ['schedule', 'ta', 'pandas', 'requests']
    
    try:
        for package in required_packages:
            __import__(package)
        print("โ ุฌููุน ุงูููุชุจุงุช ูุชููุฑุฉ")
        return True
    except ImportError as e:
        print(f"โ ุฎุทุฃ: {e}")
        return False


def create_auto_analysis_shortcut():
    """ุฅูุดุงุก ุงุฎุชุตุงุฑ ูุชุดุบูู ุงูุชุญููู ุงูุชููุงุฆู ูู ุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู"""
    print("๐ ุฅูุดุงุก ุฑุงุจุท ุงูุชูุงูู...")
    
    import_code = """
# ========== ุชูุงูู ูุธุงู ุงูุชุญููู ุงูุชููุงุฆู ==========
try:
    from auto_pairs_analyzer import run_daily_analysis, send_telegram_message
    
    def trigger_daily_analysis():
        \"\"\"ุชุดุบูู ุงูุชุญููู ุงูุดุงูู ุงููููู ูู ุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู\"\"\"
        try:
            run_daily_analysis()
        except Exception as e:
            error_msg = f"โ ุฎุทุฃ ูู ุงูุชุญููู ุงูุดุงูู: {str(e)}"
            print(error_msg)
            send_telegram_message(error_msg)
            
except ImportError:
    print("โ๏ธ ุชูุจูู: ููุชุจุฉ ุงูุชุญููู ุงูุชููุงุฆู ุบูุฑ ูุชููุฑุฉ")
# ================================================
"""
    
    print("๐ ุงูููุฏ ุงููุทููุจ ุฅุถุงูุชู ููุจุฑูุงูุฌ ุงูุฑุฆูุณู:")
    print(import_code)
    
    return import_code


def create_scheduler_launcher():
    """ุฅูุดุงุก ููู ูุชุดุบูู ุงูุฌุฏููุฉ ูู ุงูุฎูููุฉ"""
    launcher_code = '''#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
ูุดุบู ุงูุฌุฏููุฉ ุงูุชููุงุฆูุฉ ููุชุญููู ุงููููู
ูุดุบู ุงูุชุญููู ุชููุงุฆูุงู ูู ุงูููุช ุงููุญุฏุฏ
"""

import schedule
import time
import sys
from pathlib import Path

# ุฅุถุงูุฉ ูุณุงุฑ ุงููุดุฑูุน
sys.path.insert(0, str(Path(__file__).parent))

from auto_pairs_analyzer import run_daily_analysis, send_telegram_message

def schedule_job():
    """ุฌุฏููุฉ ุงููููุฉ ุงูููููุฉ"""
    schedule.every().day.at("22:00").do(job_wrapper)
    print("โ ุชู ุฌุฏููุฉ ุงูุชุญููู ุงููููู ุงูุณุงุนุฉ 22:00 UTC")

def job_wrapper():
    """ุชุบููู ุงููููุฉ ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก"""
    try:
        print(f"๐ ุจุฏุก ุงูุชุญููู ุงูุดุงูู ูู {time.strftime('%Y-%m-%d %H:%M:%S')}")
        run_daily_analysis()
        print("โ ุงูุชูู ุงูุชุญููู ุงูุดุงูู")
    except Exception as e:
        error_msg = f"โ ุฎุทุฃ ูู ุงูุชุญููู: {str(e)}"
        print(error_msg)
        send_telegram_message(error_msg)

def run_scheduler():
    """ุชุดุบูู ุงูุฌุฏููุฉ ุจุดูู ูุณุชูุฑ"""
    print("๐ค ุชู ุจุฏุก ูุธุงู ุงูุฌุฏููุฉ...")
    schedule_job()
    
    while True:
        try:
            schedule.run_pending()
            time.sleep(60)  # ุชุญูู ูู ุฏูููุฉ
        except KeyboardInterrupt:
            print("\\nโ ุชู ุฅููุงู ุงูุฌุฏููุฉ")
            sys.exit(0)
        except Exception as e:
            print(f"โ๏ธ ุฎุทุฃ: {e}")
            time.sleep(60)

if __name__ == "__main__":
    try:
        run_scheduler()
    except Exception as e:
        print(f"โ ูุดู ุจุฏุก ุงูุฌุฏููุฉ: {e}")
        sys.exit(1)
'''
    
    return launcher_code


def print_setup_instructions():
    """ุทุจุงุนุฉ ุชุนูููุงุช ุงูุฅุนุฏุงุฏ"""
    instructions = """
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         ุชุนูููุงุช ุฅุนุฏุงุฏ ูุธุงู ุงูุชุญููู ุงูุชููุงุฆู ุงูุดุงูู          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฆ ุงูุฎุทูุฉ 1: ุงูุชุซุจูุช
   ูุชู ุจุงููุนู ุชุซุจูุช ุฌููุน ุงูููุชุจุงุช ุงููุทููุจุฉ

๐ง ุงูุฎุทูุฉ 2: ุงูุชูููู
   - ุชุฃูุฏ ูู ุถุจุท ูุชุบูุฑุงุช ุงูุจูุฆุฉ:
     * MM_TELEGRAM_BOT_TOKEN
     * MM_TELEGRAM_CHAT_ID
   
   - ุฃู ุงุณุชุฎุฏู ุงูููู ุงูุงูุชุฑุงุถูุฉ ูู auto_pairs_analyzer.py

๐ ุงูุฎุทูุฉ 3: ุงูุงุณุชุฎุฏุงู
   
   ุฃ) ุชุดุบูู ุงูุชุญููู ูุฑุฉ ูุงุญุฏุฉ ูุฏููุงู:
      python auto_pairs_analyzer.py
   
   ุจ) ุชุดุบูู ุงูุฌุฏููุฉ ุงูุชููุงุฆูุฉ:
      python daily_scheduler.py
   
   ุฌ) ูู ุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู:
      - ุฃุถู ุงุณุชุฏุนุงุก trigger_daily_analysis()
      - ุฃู ุดุบู daily_scheduler.py ูููู ูููุตู

๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ:
   โ ุชุญููู 9 ุฃุฒูุงุฌ ุฑุฆูุณูุฉ
   โ ุฅุฑุณุงู ุชูุฑูุฑ ุชูุตููู ููู ุฒูุฌ
   โ ุฅุฑุณุงู ููุฎุต ุดุงูู
   โ ูู ููู ุชููุงุฆูุงู ุงูุณุงุนุฉ 22:00 UTC

๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก:
   - ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช
   - ุงุฎุชุจุฑ ุงูุจูุช: python test_telegram.py
   - ุฑุงุฌุน ุงูุณุฌูุงุช ููุฃุฎุทุงุก ุงูุชูุตูููุฉ

๐ก ููุงุญุธุงุช:
   - ุงูุณุงุนุฉ 22:00 UTC = ุงูุชุชุงุญ ุงูุณูู (ุงูุฃุญุฏ)
   - ูููู ุชุนุฏูู ุงูุฃุฒูุงุฌ ุงููุญููุฉ ูู PAIRS_TO_ANALYZE
   - ูููู ุชุบููุฑ ุงููุชุฑุฉ ุงูุฒูููุฉ ูู '1h' ุฅูู ุฃุฎุฑู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ุงูุชุซุจูุช ููุชูู! โ                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
"""
    print(instructions)


def main():
    """ุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู ููุฅุนุฏุงุฏ"""
    print("\n๐ง ุจุฑูุงูุฌ ุฅุนุฏุงุฏ ูุธุงู ุงูุชุญููู ุงูุชููุงุฆู\n")
    
    # 1. ุงูุชุญูู ูู ุงูููุชุจุงุช
    if not setup_auto_analyzer():
        print("โ ูุดู ุงูุฅุนุฏุงุฏ")
        return False
    
    # 2. ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุจูุช
    token, chat_id = get_bot_credentials()
    print(f"โ ุจูุงูุงุช ุงูุจูุช ูุญููุฉ ({chat_id})")
    
    # 3. ุนุฑุถ ุชุนูููุงุช ุงูุชูุงูู
    create_auto_analysis_shortcut()
    
    # 4. ุนุฑุถ ุชุนูููุงุช ุงูุฅุนุฏุงุฏ
    print_setup_instructions()
    
    return True


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
