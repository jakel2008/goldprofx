{% extends "base.html" %}

{% block content %}
<div class="pairs-selection-container">
    <h2>ğŸ¯ Ø§Ø®ØªØ± Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ­Ù„ÙŠÙ„Ù‡Ø§</h2>
    <p class="description">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ ÙˆØ§Ù„Ø£ØµÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªÙ„Ù‚ÙŠ ØªÙˆØµÙŠØ§ØªÙ‡Ø§ ÙˆØªØ­Ù„ÙŠÙ„Ø§ØªÙ‡Ø§</p>
    
    <div class="selection-summary">
        <div class="summary-item">
            <span class="summary-label">Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</span>
            <span id="selected-count" class="summary-value">0</span>
        </div>
        <button id="save-preferences-btn" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª</button>
        <button id="select-all-btn" class="btn btn-secondary">âœ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
        <button id="clear-all-btn" class="btn btn-secondary">âœ— Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
    </div>

    <div id="categories-container"></div>
    
    <div class="save-section">
        <button id="save-preferences-bottom-btn" class="btn btn-primary btn-large">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª</button>
    </div>
</div>

<style>
    .pairs-selection-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .pairs-selection-container h2 {
        text-align: center;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .description {
        text-align: center;
        color: #666;
        margin-bottom: 2rem;
    }
    
    .selection-summary {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .summary-item {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .summary-label {
        font-weight: bold;
        color: #667eea;
    }
    
    .summary-value {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: bold;
    }
    
    .category-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .category-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
    }
    
    .category-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-small {
        padding: 0.3rem 0.8rem;
        font-size: 0.85rem;
    }
    
    .pairs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .pair-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .pair-checkbox:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }
    
    .pair-checkbox.selected {
        background: #e7f3ff;
        border-color: #667eea;
    }
    
    .pair-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .pair-label {
        font-weight: 500;
        color: #333;
        cursor: pointer;
        flex: 1;
    }
    
    .btn-large {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        width: 100%;
        max-width: 400px;
        margin: 2rem auto;
        display: block;
    }
    
    .save-section {
        text-align: center;
        margin-top: 2rem;
    }
    
    .category-count {
        font-size: 0.9rem;
        color: #666;
        margin-left: 0.5rem;
    }
</style>

<script>
    let selectedPairs = [];
    let allPairs = {};
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø©
    async function loadAvailablePairs() {
        try {
            const response = await fetch('/api/available-pairs');
            const data = await response.json();
            allPairs = data;
            renderPairs();
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬:', error);
        }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    async function loadUserPreferences() {
        try {
            const response = await fetch('/api/user-pairs-preferences');
            const data = await response.json();
            if (data.success && data.pairs) {
                selectedPairs = data.pairs;
                updateCheckboxes();
                updateSelectedCount();
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª:', error);
        }
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬
    function renderPairs() {
        const container = document.getElementById('categories-container');
        container.innerHTML = '';
        
        const categoryNames = {
            'forex_major': 'ğŸ’± Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„ÙÙˆØ±ÙƒØ³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
            'forex_minor': 'ğŸ’± Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„ÙÙˆØ±ÙƒØ³ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©',
            'metals': 'ğŸ¥‡ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ø«Ù…ÙŠÙ†Ø©',
            'energy': 'âš¡ Ø§Ù„Ø·Ø§Ù‚Ø©',
            'indices_us': 'ğŸ“Š Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ©',
            'indices_europe': 'ğŸ“Š Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠØ©',
            'indices_asia': 'ğŸ“Š Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¢Ø³ÙŠÙˆÙŠØ©',
            'crypto': 'â‚¿ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©'
        };
        
        for (const [category, pairs] of Object.entries(allPairs)) {
            const section = document.createElement('div');
            section.className = 'category-section';
            
            const pairsArray = Object.keys(pairs);
            
            section.innerHTML = `
                <div class="category-header">
                    <div>
                        <span class="category-title">${categoryNames[category] || category}</span>
                        <span class="category-count">(${pairsArray.length} Ø²ÙˆØ¬)</span>
                    </div>
                    <div class="category-actions">
                        <button class="btn btn-small btn-secondary" onclick="selectCategory('${category}')">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                        <button class="btn btn-small btn-secondary" onclick="deselectCategory('${category}')">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
                <div class="pairs-grid" id="category-${category}"></div>
            `;
            
            container.appendChild(section);
            
            const pairsGrid = document.getElementById(`category-${category}`);
            pairsArray.forEach(pair => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'pair-checkbox';
                pairDiv.innerHTML = `
                    <input type="checkbox" id="pair-${pair}" value="${pair}" onchange="togglePair('${pair}')">
                    <label for="pair-${pair}" class="pair-label">${pair}</label>
                `;
                pairsGrid.appendChild(pairDiv);
            });
        }
        
        updateCheckboxes();
        updateSelectedCount();
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù€ checkboxes
    function updateCheckboxes() {
        document.querySelectorAll('.pair-checkbox input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = selectedPairs.includes(checkbox.value);
            if (checkbox.checked) {
                checkbox.parentElement.classList.add('selected');
            } else {
                checkbox.parentElement.classList.remove('selected');
            }
        });
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø²ÙˆØ¬
    function togglePair(pair) {
        const index = selectedPairs.indexOf(pair);
        if (index > -1) {
            selectedPairs.splice(index, 1);
        } else {
            selectedPairs.push(pair);
        }
        updateCheckboxes();
        updateSelectedCount();
    }
    
    // ØªØ­Ø¯ÙŠØ¯ ÙØ¦Ø© ÙƒØ§Ù…Ù„Ø©
    function selectCategory(category) {
        const pairs = Object.keys(allPairs[category]);
        pairs.forEach(pair => {
            if (!selectedPairs.includes(pair)) {
                selectedPairs.push(pair);
            }
        });
        updateCheckboxes();
        updateSelectedCount();
    }
    
    // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙØ¦Ø©
    function deselectCategory(category) {
        const pairs = Object.keys(allPairs[category]);
        selectedPairs = selectedPairs.filter(p => !pairs.includes(p));
        updateCheckboxes();
        updateSelectedCount();
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
    document.getElementById('select-all-btn').addEventListener('click', () => {
        selectedPairs = [];
        for (const pairs of Object.values(allPairs)) {
            selectedPairs.push(...Object.keys(pairs));
        }
        updateCheckboxes();
        updateSelectedCount();
    });
    
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
    document.getElementById('clear-all-btn').addEventListener('click', () => {
        selectedPairs = [];
        updateCheckboxes();
        updateSelectedCount();
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    function updateSelectedCount() {
        document.getElementById('selected-count').textContent = selectedPairs.length;
    }
    
    // Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
    async function savePreferences() {
        try {
            const response = await fetch('/api/save-pairs-preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pairs: selectedPairs
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('âœ… ØªÙ… Ø­ÙØ¸ ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!');
            } else {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª:', error);
            alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
        }
    }
    
    document.getElementById('save-preferences-btn').addEventListener('click', savePreferences);
    document.getElementById('save-preferences-bottom-btn').addEventListener('click', savePreferences);
    
    // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    loadAvailablePairs().then(() => loadUserPreferences());
</script>
{% endblock %}
